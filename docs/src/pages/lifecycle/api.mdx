import { Callout } from 'nextra-theme-docs'

# å¸¸ç”¨ API

## åˆå§‹åŒ–å®ä¾‹

### `Mahiro.start`

å¯åŠ¨ Mahiro å®ä¾‹ã€‚

```ts
  const mahiro = await Mahiro.start({
    // å¿…å¡«å­—æ®µ
    qq: 123456789,

    // éå¿…é€‰å­—æ®µ
    // é»˜è®¤ æœ¬åœ°
    host: `127.0.0.1`,
    // é»˜è®¤ 8086
    port: 8086,

    // é«˜çº§åŠŸèƒ½
    advancedOptions: {}
  })
```

## ç›‘å¬æ¶ˆæ¯

### `onGroupMessage`

ç›‘å¬ç¾¤ç»„æ¶ˆæ¯ã€‚

```ts
  mahiro.onGroupMessage('Group Plugin', (data) => {
    if (['ping', 'pong'].includes(data?.msg?.Content)) {
      mahiro.sendGroupMessage({
        groupId: data.groupId,
        msg: {
          Content: 'pong',
        }
      })
    }
  })
```

### `onFriendMessage`

ç›‘å¬ç§äººæ¶ˆæ¯ã€‚

```ts
  mahiro.onFriendMessage('Friend Plugin', async (data) => {
    if (data?.msg?.Content === 'ä½ æ˜¯è°') {
      mahiro.sendFriendMessage({
        userId: data.userId,
        msg: {
          Content: 'Mahiro',
        },
      })
    }
  })
```

## å‘é€æ¶ˆæ¯

### `sendGroupMessage`

å‘é€ç¾¤ç»„æ¶ˆæ¯ã€‚

```ts
  import { join } from 'path'

  mahiro.sendGroupMessage({
    groupId,
    // æ–‡æœ¬æ¶ˆæ¯
    msg: {
      Content: "text"
    },
    // å‘é€å›¾ç‰‡ï¼šå¯ä»¥æ˜¯ æœ¬åœ°æ–‡ä»¶ç»å¯¹è·¯å¾„ / Base64 / Url
    fastImage: join(__dirname, './image.jpg')
  })
```

### `sendFriendMessage`

å‘é€ç§äººæ¶ˆæ¯ã€‚

```ts
  mahiro.sendFriendMessage({
    userId,
    // æ–‡æœ¬æ¶ˆæ¯
    msg: {
      Content: "text"
    },
    // å‘é€å›¾ç‰‡ï¼šå¯ä»¥æ˜¯ æœ¬åœ°æ–‡ä»¶ç»å¯¹è·¯å¾„ / Base64 / Url
    fastImage: join(__dirname, './image.jpg')
  })
```

## è¿ç»­å¯¹è¯

### å¯ç”¨

ä½¿ç”¨è¿ç»­å¯¹è¯åŠŸèƒ½éœ€ä¾èµ– redis ï¼Œè¯·å‚è€ƒ [KV å­˜å‚¨](./kv#dbrediskv-redis) å¼€å¯ `redisKV` ã€‚

### ç¤ºä¾‹

å½“æ³¨å†Œ `onGroupMessage` / `onFriendMessage` çš„ç¬¬äºŒä¸ªå‚æ•°ä¸ºæ•°ç»„æ—¶ï¼Œå¯ä½¿ç”¨ session è¿ç»­å¯¹è¯åŠŸèƒ½ï¼Œé€šè¿‡æ¯ä¸ªå¯¹è±¡çš„ `matched` è¿”å›å€¼å†³å®šæ˜¯å¦æ¨è¿›è‡³ä¸‹ä¸€é˜¶æ®µã€‚

```ts
  mahiro.onGroupMessage('session', [
    // stage 1
    {
      matched: async (data) => {
        if (data?.msg?.Content === 'ä½ æ˜¯è°') {
          mahiro.sendGroupMessage({
            groupId: data.groupId,
            msg: {
              Content: 'ä½ å†é—®é—®',
            },
          })
          return true
        }
        return false
      }
    },
    // stage 2
    {
      matched: async (data) => {
        if (data?.msg?.Content === 'ä½ æ˜¯è°') {
          mahiro.sendGroupMessage({
            groupId: data.groupId,
            msg: {
              Content: 'æˆ‘æ˜¯ Mahiro',
            },
          })
          return false
        }
        return false
      }
    }
  ])
```

#### `matched`

1. å½“è¿”å› `true` æ—¶ï¼Œä¸‹ä¸€æ¡æ¶ˆæ¯å°†åœ¨ä¸‹ä¸€é˜¶æ®µè¿›è¡ŒåŒ¹é…ã€‚

2. å½“è¿”å› `false` æ—¶ï¼Œä¸­æ–­ã€‚

3. æœ€åä¸€é˜¶æ®µçš„è¿”å›å€¼ä¸é‡è¦ï¼Œå› ä¸ºæ²¡æœ‰ä¸‹ä¸€é˜¶æ®µï¼Œå¯¹è¯ç»“æŸäº†ã€‚

#### TTL

è¿‡æœŸæ—¶é—´ç”± `MAHIRO_SESSION_TTL` ç¯å¢ƒå˜é‡æŒ‡å®šï¼ˆå•ä½ `ms`ï¼‰ï¼Œé»˜è®¤ `10000`ï¼ˆ`10s`ï¼‰ã€‚

## å¸¸ç”¨ä¿¡æ¯

### ~~`getGroupList`~~

 - available version: `<= 12.0.0`

~~è·å–ç¾¤ç»„åˆ—è¡¨~~ ï¼Œå·²åºŸå¼ƒã€‚

### `avatar.getUserAvatarUrl`

è·å–ç”¨æˆ·å¤´åƒã€‚

```ts
  const url = await mahiro.avatar.getUserAvatarUrl(qq, size)
```

<Callout type="warning">
  ä¸ä¿è¯ä¸€å®šè·å–åˆ°ï¼Œè¯·å…œåº•å¤„ç†
</Callout>

### `avatar.getUserQzoneInfo`

è·å–ç”¨æˆ·ç©ºé—´åŸºç¡€ä¿¡æ¯ã€‚

```ts
  const info = await mahiro.avatar.getUserQzoneInfo(qq)
  info?.avatar
  info?.nickname
```

ä¸€èˆ¬ç”¨äºè·å–ä¸ªäººæ˜µç§°ã€‚

<Callout type="warning">
  ä¸ä¿è¯ä¸€å®šè·å–åˆ°ï¼Œè¯·å…œåº•å¤„ç†
</Callout>

## æ“ä½œ API

### `baka.banGroupMember`

åœ¨æ¶ˆæ¯å“åº”ä¸­ç¦è¨€ç¾¤ç»„æˆå‘˜ï¼š

```ts
mahiro.onGroupMessage('ban', async (data) => {
  if (data.msg?.Content === 'I need ban') {
    mahiro.baka.banGroupMember({
      to: data.banTo,
      BanTime: 60 // 60s - (30 * 24 * 3600)s (30 days), use 0 unlock
    })
  }
})
```

æ‰‹åŠ¨ç¦è¨€ç¾¤ç»„æˆå‘˜ï¼š

```ts
mahiro.baka.banGroupMember({
  groupId,
  userId,
  BanTime: 0 // use `0` unlock
})
```

<Callout type="info" emoji="â„¹ï¸">
  ä½¿ç”¨æ‰‹åŠ¨ç¦è¨€éœ€å¼€å¯ Redis ï¼Œè¯¦è§ [KV å­˜å‚¨](./kv#dbrediskv-redis)
</Callout>

### `baka.kickGroupMember`

ç§»é™¤ç¾¤ç»„æˆå‘˜ï¼š

```ts
mahiro.onGroupMessage('kick', async (data) => {
  if (data.msg?.Content === 'ping') {
    mahiro.baka.kickGroupMember({
      to: data.kickTo,
    })
  }
})
```

æ‰‹åŠ¨ç§»é™¤ç¾¤ç»„æˆå‘˜ï¼š

```ts
mahiro.baka.kickGroupMember({
  groupId,
  userId
})
```

<Callout type="info" emoji="â„¹ï¸">
  ä½¿ç”¨æ‰‹åŠ¨ç§»é™¤éœ€å¼€å¯ Redis ï¼Œè¯¦è§ [KV å­˜å‚¨](./kv#dbrediskv-redis)
</Callout>

### `baka.dropGroupMessage`

æ’¤å›ç¾¤ç»„æ¶ˆæ¯ï¼š

```ts
mahiro.onGroupMessage('drop', async (data) => {
  if (data.msg?.Content === 'ErrorMessage') {
    mahiro.baka.dropGroupMessage({
      to: data.dropTo
    })
  }
})
```

æ’¤å›è‡ªå·±æ¶ˆæ¯ï¼š

```ts
mahiro.onGroupMessage('revoke', async (data) => {
  if (data.msg?.Content === 'Hello') {
    const op = await mahiro.sendGroupMessage()
    
    // 5s after revoke
    setTimeout(() => {
      op?.drop()
    }, 5 * 1000)
  }
})
```

<Callout type="info" emoji="â„¹ï¸">
  æ’¤å›è‡ªå·±æ¶ˆæ¯éœ€å¼€å¯ Redis ï¼Œè¯¦è§ [KV å­˜å‚¨](./kv#dbrediskv-redis) ï¼›é»˜è®¤æœ‰æ•ˆæœŸé»˜è®¤ä¸º 2 åˆ†é’Ÿï¼Œè¿‡æœŸåä¸å¯æ’¤å›ã€‚
</Callout>

### `baka.getGroupListMap`

è·å–è´¦å·ç¾¤ç»„åˆ—è¡¨çš„æ˜ å°„ã€‚

```ts
  const map = await mahiro.baka.getGroupListMap()
  const groupInfo = map?.[groupId]

  // ğŸŸ¡ refresh cache: very dangerous
  await mahiro.baka.getGroupListMap({ force: true })
```

<Callout type="info" emoji="â„¹ï¸">
  ä½¿ç”¨è¯¥åŠŸèƒ½éœ€å¼€å¯ Redis ï¼Œè¯¦è§ [KV å­˜å‚¨](./kv#dbrediskv-redis) ï¼›é»˜è®¤ `20` åˆ†é’Ÿç¼“å­˜ï¼Œä½¿ç”¨ `force` åˆ·æ–°ç¼“å­˜æˆ–è°ƒæ•´ `MAHIRO_GROUP_DATA_TTL`
</Callout>

### `baka.getGroupMemberListMap`

è·å–æŸç¾¤ç»„æˆå‘˜çš„æ˜ å°„ã€‚

```ts
  const map = await mahiro.baka.getGroupMemberListMap({ groupId })
  const userInfo = map?.[userId]

  // ğŸŸ¡ refresh cache: very dangerous
  await mahiro.baka.getGroupMemberListMap({ groupId, force: true })
```

<Callout type="info" emoji="â„¹ï¸">
  ä½¿ç”¨è¯¥åŠŸèƒ½éœ€å¼€å¯ Redis ï¼Œè¯¦è§ [KV å­˜å‚¨](./kv#dbrediskv-redis) ï¼›é»˜è®¤ `20` åˆ†é’Ÿç¼“å­˜ï¼Œä½¿ç”¨ `force` åˆ·æ–°ç¼“å­˜æˆ–è°ƒæ•´ `MAHIRO_GROUP_DATA_TTL`
</Callout>

## é«˜çº§ API

### `onNativeEvent`

ç›‘å¬åŸå§‹çš„ OPQ æ¶ˆæ¯ä½“ã€‚

#### å›è°ƒæ—¶æœº

åœ¨ Native Middleware åï¼Œç«‹å³è°ƒç”¨ï¼Œè¯¦è§ [API è°ƒç”¨é¡ºåº](../lifecycle#api-è°ƒç”¨é¡ºåº) ã€‚

#### ç‰¹æ€§

è¯·åœ¨äº†è§£ä»¥ä¸‹ç‰¹ç‚¹åå†ä½¿ç”¨æ­¤ API ï¼š

|ç‰¹ç‚¹|è¯´æ˜|
|:-|:-|
|ç¾¤é‰´æƒ|ä¸æ”¯æŒï¼Œå› ä¸º Native äº‹ä»¶åœ¨æ‰€æœ‰æ¶ˆæ¯å¤„ç†ä¹‹å‰|
|å¿½ç•¥è‡ªèº«|ä¸æ”¯æŒï¼Œæ‰€æœ‰çš„äº‹ä»¶ï¼ˆåŒ…æ‹¬è‡ªå·±å’Œä»»ä½•äººï¼‰éƒ½ä¼šæ”¶åˆ°|

### `onGroupEvent`

ç›‘å¬ç¾¤ç»„äººå‘˜å˜åŠ¨äº‹ä»¶ã€‚

<Callout type="warning">
  ç°åœ¨å›ä¼ ä¿¡æ¯è¿˜ä¸å¤Ÿå…¨é¢ï¼Œè¯·é…Œæƒ…ä½¿ç”¨ã€‚
</Callout>

### `searchUser`

æ ¹æ®ç”¨æˆ· `Uid` æŸ¥ä¸ªäººä¿¡æ¯ã€‚

```ts
import { EAvatarSize } from 'mahiro'

const user = await mahiro.searchUser({ qq, Uid })
// å¤´åƒéœ€æŒ‡å®šå°ºå¯¸åä½¿ç”¨
const avatarUrl = `${user.Head}${EAvatarSize.s_640}`
```

> åˆ«åï¼š`getUserInfo`

### `baka.getUserInfoCache2LevelByUin`

è·å–æŸè´¦å·çš„å…ƒä¿¡æ¯ã€‚

```ts
  const user = await mahiro.baka.getUserInfoCache2LevelByUin(userId)
  user?.SenderUid
```

<Callout type="info" emoji="â„¹ï¸">
  ä½¿ç”¨è¯¥åŠŸèƒ½éœ€å¼€å¯ Redis ï¼Œè¯¦è§ [KV å­˜å‚¨](./kv#dbrediskv-redis) ï¼›é»˜è®¤ `20` åˆ†é’Ÿç¼“å­˜ï¼Œä½¿ç”¨ `MAHIRO_GROUP_DATA_TTL` è°ƒæ•´
</Callout>

## å±é™© API

<Callout type="error" emoji="ï¸âŒ">
  è¿™äº› API æ¶‰åŠåˆ°æé«˜çš„å°ç¦é£é™©ï¼Œåœ¨ä½¿ç”¨å‰ï¼Œè¯·åšå¥½ **æ”¾å¼ƒè´¦å·çš„å‡†å¤‡** å’Œç›¸å…³å¤‡ä»½ã€‚
</Callout>

### `rail.replyGroupMessage`

å›å¤æŸä¸€æ¡ç¾¤ç»„æ¶ˆæ¯ï¼š

```ts
mahiro.onGroupMessage('reply', async (data) => {
  if (data.msg?.Content === 'ping') {
    mahiro.rail.replyGroupMessage({
      to: data.replyTo,
      msg: {
        Content: 'pong'
      }
    })
  }
})
```

### `rail.sendGroupJsonMessage`

```ts
  mahiro.rail.sendGroupJsonMessage({ groupId, json })
```

### `rail.sendGroupXMLMessage`

```ts
  mahiro.rail.sendGroupXMLMessage({ groupId, xml })
```
